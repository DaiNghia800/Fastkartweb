@model Fastkart.Models.Entities.Pages
@{
    Layout = "_LayoutAdmin";
    ViewData["title"] = Model?.Uid > 0 ? "Edit Page" : "Create New Page";
    bool isEdit = Model?.Uid > 0;
}

<style>
    .page-form-container {
        padding: 20px 0;
    }

    .page-form-card {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
    }

    .page-form-header {
        background: linear-gradient(135deg, #009289 0%, #0da487 100%);
        color: white;
        padding: 25px 30px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

        .page-form-header h5 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .page-form-header .btn {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.5);
            color: white;
            font-weight: 600;
            padding: 8px 20px;
        }

            .page-form-header .btn:hover {
                background: white;
                color: #009289;
            }

    .card-body {
        padding: 30px;
    }

    .form-label {
        font-weight: 600;
        color: #2d3748;
        margin-bottom: 8px;
        font-size: 0.95rem;
    }

    .form-control, .form-select {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        padding: 10px 14px;
        font-size: 0.95rem;
        transition: all 0.3s ease;
    }

        .form-control:focus, .form-select:focus {
            border-color: #009289;
            box-shadow: 0 0 0 3px rgba(0, 146, 137, 0.1);
        }

    .form-control-lg {
        padding: 12px 16px;
        font-size: 1.1rem;
        font-weight: 600;
    }

    /* Cải thiện textarea */
    textarea.form-control {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        line-height: 1.6;
        resize: vertical;
        min-height: 400px;
    }

    .content-editor-wrapper {
        position: relative;
    }

    .editor-toolbar {
        background: #f8f9fa;
        padding: 10px;
        border: 1px solid #e2e8f0;
        border-bottom: none;
        border-radius: 8px 8px 0 0;
        display: flex;
        gap: 5px;
        flex-wrap: wrap;
    }

    .editor-btn {
        padding: 6px 12px;
        border: 1px solid #cbd5e0;
        background: white;
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.85rem;
        transition: all 0.2s;
    }

        .editor-btn:hover {
            background: #009289;
            color: white;
            border-color: #009289;
        }

    .editor-textarea {
        border-radius: 0 0 8px 8px !important;
        border-top: none !important;
    }

    .card {
        border: 1px solid #e2e8f0;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        margin-bottom: 20px;
    }

    .card-header {
        background: #f8f9fa;
        padding: 15px 20px;
        border-bottom: 1px solid #e2e8f0;
    }

        .card-header h6 {
            font-weight: 700;
            color: #2d3748;
            margin: 0;
            font-size: 1rem;
        }

    .card-body {
        padding: 20px;
    }

    .btn {
        border-radius: 8px;
        padding: 10px 24px;
        font-weight: 600;
        font-size: 0.95rem;
        transition: all 0.3s ease;
        border: none;
    }

    .btn-primary {
        background: #009289;
        color: white;
    }

        .btn-primary:hover {
            background: #007b73;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 146, 137, 0.3);
        }

    .btn-secondary {
        background: #6c757d;
        color: white;
    }

        .btn-secondary:hover {
            background: #5a6268;
        }

    .btn-outline-danger {
        border: 2px solid #dc3545;
        color: #dc3545;
        background: transparent;
    }

        .btn-outline-danger:hover {
            background: #dc3545;
            color: white;
        }

    .btn-lg {
        padding: 12px 30px;
        font-size: 1rem;
    }

    .alert {
        border-radius: 8px;
        border: none;
        padding: 15px 20px;
        margin-bottom: 20px;
        font-weight: 500;
    }

    .alert-danger {
        background: #fee;
        color: #c33;
    }

    .alert-success {
        background: #d4edda;
        color: #155724;
    }

    #slugPreview {
        background: #f0f8f7 !important;
        color: #009289;
        font-family: 'Courier New', monospace;
        font-weight: 600;
    }

    .slug-info {
        background: #e8f5f4;
        padding: 12px;
        border-radius: 6px;
        margin-top: 10px;
        font-size: 0.9rem;
        color: #00695c;
    }

    .action-buttons {
        padding-top: 20px;
        margin-top: 20px;
        border-top: 2px solid #f0f0f0;
    }

    @@media (max-width: 991px) {
        .card-body

    {
        padding: 20px;
    }

    textarea.form-control {
        min-height: 300px;
    }

    }
</style>

<section class="page-form-container">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="page-form-card">
                    <div class="page-form-header">
                        <h5>
                            <i class="fa fa-@(isEdit ? "edit" : "plus-circle") me-2"></i>
                            @(isEdit ? "Edit Page" : "Create New Page")
                        </h5>
                        <a href="/admin/list-page" class="btn btn-sm">
                            <i class="fa fa-arrow-left me-2"></i> Back to List
                        </a>
                    </div>

                    <div class="card-body">
                        @* HIỂN THỊ THÔNG BÁO *@
                        @if (TempData["SuccessMessage"] != null)
                        {
                            <div class="alert alert-success alert-dismissible fade show" role="alert">
                                <i class="fa fa-check-circle me-2"></i>
                                @TempData["SuccessMessage"]
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        }

                        @if (ViewBag.ErrorMessage != null)
                        {
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="fa fa-exclamation-triangle me-2"></i>
                                @ViewBag.ErrorMessage
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        }

                        <form method="post" class="needs-validation" novalidate>
                            <input type="hidden" asp-for="Uid" />

                            <div class="row">
                                <!-- LEFT COLUMN -->
                                <div class="col-lg-8">
                                    <!-- Title -->
                                    <div class="mb-4">
                                        <label class="form-label" asp-for="Title">
                                            Page Title <span class="text-danger">*</span>
                                        </label>
                                        <input class="form-control form-control-lg"
                                               asp-for="Title"
                                               type="text"
                                               placeholder="Enter page title (e.g., About Us, Contact)"
                                               required>
                                        <span asp-validation-for="Title" class="text-danger small"></span>
                                    </div>

                                    <!-- Content Editor -->
                                    <div class="mb-4">
                                        <label class="form-label" asp-for="Content">
                                            Page Content <span class="text-danger">*</span>
                                        </label>

                                        <div class="content-editor-wrapper">
                                            <div class="editor-toolbar">
                                                <button type="button" class="editor-btn" onclick="insertTag('h2', 'Heading 2')" title="Heading 2">
                                                    <i class="fa fa-heading"></i> H2
                                                </button>
                                                <button type="button" class="editor-btn" onclick="insertTag('h3', 'Heading 3')" title="Heading 3">
                                                    <i class="fa fa-heading"></i> H3
                                                </button>
                                                <button type="button" class="editor-btn" onclick="insertTag('p', 'Paragraph text')" title="Paragraph">
                                                    <i class="fa fa-paragraph"></i>
                                                </button>
                                                <button type="button" class="editor-btn" onclick="insertTag('strong', 'Bold text')" title="Bold">
                                                    <i class="fa fa-bold"></i>
                                                </button>
                                                <button type="button" class="editor-btn" onclick="insertTag('em', 'Italic text')" title="Italic">
                                                    <i class="fa fa-italic"></i>
                                                </button>
                                                <button type="button" class="editor-btn" onclick="insertList('ul')" title="Bullet List">
                                                    <i class="fa fa-list-ul"></i>
                                                </button>
                                                <button type="button" class="editor-btn" onclick="insertList('ol')" title="Numbered List">
                                                    <i class="fa fa-list-ol"></i>
                                                </button>
                                                <button type="button" class="editor-btn" onclick="insertLink()" title="Insert Link">
                                                    <i class="fa fa-link"></i>
                                                </button>
                                            </div>

                                            <textarea class="form-control editor-textarea"
                                                      asp-for="Content"
                                                      id="pageContent"
                                                      placeholder="Enter your page content here. You can use HTML tags for formatting."
                                                      required></textarea>
                                        </div>

                                        <span asp-validation-for="Content" class="text-danger small"></span>
                                        <small class="text-muted d-block mt-2">
                                            <i class="fa fa-info-circle"></i>
                                            Tip: Use the toolbar above to quickly insert HTML tags, or write HTML directly.
                                        </small>
                                    </div>
                                </div>

                                <!-- RIGHT COLUMN - Sidebar -->
                                <div class="col-lg-4">
                                    <!-- Publish Settings -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fa fa-cog me-2"></i>Publish Settings</h6>
                                        </div>
                                        <div class="card-body">
                                            <!-- Status -->
                                            <div class="mb-3">
                                                <label class="form-label">Status</label>
                                                <select class="form-select" asp-for="Status">
                                                    <option value="Published">✓ Published</option>
                                                    <option value="Draft">📝 Draft</option>
                                                    <option value="Pending">⏳ Pending Review</option>
                                                </select>
                                            </div>

                                            <!-- Author -->
                                            <div class="mb-3">
                                                <label class="form-label">
                                                    Author <span class="text-danger">*</span>
                                                </label>
                                                <select class="form-select" asp-for="AuthorUid" required>
                                                    <option value="">Select Author</option>
                                                    @if (ViewBag.Authors != null)
                                                    {
                                                        foreach (var author in ViewBag.Authors)
                                                        {
                                                            <option value="@author.Uid" selected="@(Model?.AuthorUid == author.Uid)">
                                                                @author.FullName
                                                            </option>
                                                        }
                                                    }
                                                </select>
                                            </div>

                                            @if (isEdit && Model.PublishedAt.HasValue)
                                            {
                                                <div class="mb-3">
                                                    <label class="form-label">Published Date</label>
                                                    <input type="text"
                                                           class="form-control"
                                                           value="@Model.PublishedAt.Value.ToString("dd MMM yyyy, hh:mm tt")"
                                                           readonly>
                                                </div>
                                            }
                                        </div>
                                    </div>

                                    <!-- URL Slug Info -->
                                    <div class="card">
                                        <div class="card-header">
                                            <h6><i class="fa fa-link me-2"></i>URL Slug</h6>
                                        </div>
                                        <div class="card-body">
                                            <input type="text"
                                                   class="form-control"
                                                   id="slugPreview"
                                                   readonly
                                                   placeholder="auto-generated-from-title">

                                            <div class="slug-info mt-3">
                                                <strong>What is URL Slug?</strong>
                                                <p class="mb-0 mt-2">
                                                    URL Slug là phần cuối của địa chỉ web. Ví dụ: nếu slug là "about-us",
                                                    trang sẽ có địa chỉ: <code>yoursite.com/page/about-us</code>
                                                </p>
                                                <p class="mb-0 mt-2">
                                                    Slug sẽ được tự động tạo từ tiêu đề, không dấu, viết thường,
                                                    các từ cách nhau bằng dấu gạch ngang (-).
                                                </p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <div class="action-buttons">
                                <div class="row">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-primary btn-lg" type="submit">
                                                    <i class="fa fa-save me-2"></i>
                                                    @(isEdit ? "Update Page" : "Create Page")
                                                </button>
                                                <a href="/admin/list-page" class="btn btn-secondary btn-lg">
                                                    <i class="fa fa-times me-2"></i> Cancel
                                                </a>
                                                @if (isEdit)
                                                {
                                                    <button type="button" class="btn btn-outline-danger btn-lg" onclick="confirmDelete(@Model.Uid)">
                                                        <i class="fa fa-trash me-2"></i> Delete
                                                    </button>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script>
        const contentArea = document.getElementById('pageContent');

        // Auto-generate slug
        function generateSlug(text) {
            return text
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/đ/g, 'd')
                .replace(/[^a-z0-9\s-]/g, '')
                .replace(/\s+/g, '-')
                .replace(/-+/g, '-')
                .trim();
        }

        document.querySelector('[name="Title"]').addEventListener('input', function(e) {
            const slug = generateSlug(e.target.value);
            document.getElementById('slugPreview').value = slug || 'auto-generated-from-title';
        });

        // Editor helper functions
        function insertTag(tag, defaultText) {
            const start = contentArea.selectionStart;
            const end = contentArea.selectionEnd;
            const selectedText = contentArea.value.substring(start, end) || defaultText;
            const newText = `<${tag}>${selectedText}</${tag}>`;

            contentArea.setRangeText(newText, start, end, 'end');
            contentArea.focus();
        }

        function insertList(type) {
            const start = contentArea.selectionStart;
            const listHtml = type === 'ul'
                ? '<ul>\n    <li>Item 1</li>\n    <li>Item 2</li>\n    <li>Item 3</li>\n</ul>'
                : '<ol>\n    <li>Item 1</li>\n    <li>Item 2</li>\n    <li>Item 3</li>\n</ol>';

            contentArea.setRangeText(listHtml, start, start, 'end');
            contentArea.focus();
        }

        function insertLink() {
            const url = prompt('Enter URL:', 'https://');
            if (url) {
                const text = prompt('Enter link text:', 'Click here');
                if (text) {
                    const start = contentArea.selectionStart;
                    const linkHtml = `<a href="${url}">${text}</a>`;
                    contentArea.setRangeText(linkHtml, start, start, 'end');
                    contentArea.focus();
                }
            }
        }

        // Initial slug load
        window.addEventListener('load', function() {
            const title = document.querySelector('[name="Title"]').value;
            if(title) {
                document.getElementById('slugPreview').value = generateSlug(title);
            }
        });

        // Form validation
        (function() {
            'use strict';
            var forms = document.querySelectorAll('.needs-validation');
            Array.prototype.slice.call(forms).forEach(function(form) {
                form.addEventListener('submit', function(event) {
                    if (!form.checkValidity()) {
                        event.preventDefault();
                        event.stopPropagation();
                    }
                    form.classList.add('was-validated');
                }, false);
            });
        })();

        // Delete confirmation
        function confirmDelete(uid) {
            if(confirm('⚠️ Are you sure you want to delete this page?\n\nThis action cannot be undone!')) {
                window.location.href = '/admin/list-page/delete/' + uid;
            }
        }
    </script>
}