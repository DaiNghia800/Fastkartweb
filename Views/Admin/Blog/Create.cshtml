@{
    Layout = "_LayoutAdmin";
    ViewData["title"] = "Create Blog";
    var blogId = Context.Request.RouteValues["id"]?.ToString();
    var isEdit = !string.IsNullOrEmpty(blogId);
}

<!-- === BƯỚC 1: THÊM THƯ VIỆN TINYMCE === -->
<!-- (Lưu ý: "no-api-key" chỉ dùng cho development. Bạn nên đăng ký 1 key miễn phí tại tiny.cloud) -->
<script src="https://cdn.tiny.cloud/1/7nqs4zx0dy5w83sqeyqph782x1tmsw33d4nyk0pngc6c5zvi/tinymce/6/tinymce.min.js" referrerpolicy="origin"></script>
<style>
    /* ... (CSS cũ từ .blog-form-container đến .spinner) ... */
    .blog-form-container {
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    .form-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
    }

    .form-title {
        font-size: 28px;
        font-weight: 600;
        color: #333;
        margin: 0;
    }

    .back-btn {
        padding: 10px 20px;
        background-color: #6c757d;
        color: white;
        border: none;
        border-radius: 8px;
        text-decoration: none;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        transition: all 0.3s;
    }

        .back-btn:hover {
            background-color: #5a6268;
            transform: translateX(-3px);
        }

    .form-card {
        background: white;
        border-radius: 12px;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .form-section {
        margin-bottom: 35px;
    }

    .section-title {
        font-size: 18px;
        font-weight: 600;
        color: #333;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 2px solid #14a38b;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 20px;
    }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

    .form-label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: #333;
        font-size: 14px;
    }

    .required {
        color: #dc3545;
        margin-left: 3px;
    }

    .form-input,
    .form-select,
    .form-textarea {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s;
        font-family: inherit;
    }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #14a38b;
            box-shadow: 0 0 0 3px rgba(20, 163, 139, 0.1);
        }

    .form-textarea {
        min-height: 200px;
        resize: vertical;
    }

    .image-preview-container {
        margin-top: 10px;
    }

    .image-preview {
        max-width: 300px;
        max-height: 200px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        display: none;
    }

        .image-preview.show {
            display: block;
        }

    .form-actions {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        padding-top: 20px;
        border-top: 1px solid #dee2e6;
    }

    .btn {
        padding: 12px 30px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        font-weight: 500;
        transition: all 0.3s;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-primary {
        background-color: #14a38b;
        color: white;
    }

        .btn-primary:hover {
            background-color: #0f8570;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(20, 163, 139, 0.3);
        }

        .btn-primary:disabled {
            background-color: #ccc;
            cursor: not-allowed;
            transform: none;
        }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

        .btn-secondary:hover {
            background-color: #5a6268;
        }

    .alert {
        padding: 15px 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

        .alert.show {
            display: block;
        }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-danger {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .loading-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        z-index: 9999;
        justify-content: center;
        align-items: center;
    }

        .loading-overlay.show {
            display: flex;
        }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #14a38b;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    /* === BƯỚC 2: Thêm style cho TinyMCE === */
    .tox-tinymce {
        border-radius: 8px !important; /* Ghi đè style mặc định */
        border: 1px solid #ddd !important;
    }

    .tox .tox-statusbar {
        border-top: 1px solid #eee !important;
    }
</style>

<div class="blog-form-container">
    <div class="form-header">
        <h1 class="form-title" id="pageTitle">
            @if (isEdit)
            {
                <text>Edit Blog</text>
            }
            else
            {
                <text>➕ Create New Blog</text>
            }
        </h1>
        <a href="/admin/blog" class="back-btn">
            ← Back to List
        </a>
    </div>

    <!-- ... (Alerts không đổi) ... -->
    <div class="alert alert-success" id="successAlert">
        <strong>Success!</strong> <span id="successMessage"></span>
    </div>
    <div class="alert alert-danger" id="errorAlert">
        <strong>Error!</strong> <span id="errorMessage"></span>
    </div>

    <div class="form-card">
        <form id="blogForm">
            <input type="hidden" id="blogUid" value="@blogId" />

            <!-- Basic Information -->
            <div class="form-section">
                <h3 class="section-title">Basic Information</h3>

                <!-- ... (Title, Category, Image Upload không đổi) ... -->
                <div class="form-group">
                    <label class="form-label">
                        Title <span class="required">*</span>
                    </label>
                    <input type="text"
                           id="title"
                           class="form-input"
                           placeholder="Enter blog title..."
                           required />
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">
                            Category <span class="required">*</span>
                        </label>
                        <select id="categoryUid" class="form-select" required>
                            <option value="">Select Category</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Image URL</label>
                    <input type="text"
                           id="imageUrl"
                           class="form-input"
                           placeholder="Enter image URL..."
                           onchange="previewImage()" />
                    <div style="display: flex; gap: 10px; margin-top: 10px;">
                        <input type="file" id="imageFile" class="form-input" accept="image/*" style="flex-grow: 1;">
                        <button type="button" class="btn btn-secondary" id="uploadBtn" style="flex-shrink: 0;">
                            Upload
                        </button>
                    </div>
                    <div class="image-preview-container">
                        <img id="imagePreview" class="image-preview" alt="Preview" />
                    </div>
                </div>
            </div>

            <!-- Content -->
            <div class="form-section">
                <h3 class="section-title">Content</h3>

                <div class="form-group">
                    <label class="form-label">
                        Blog Content <span class="required">*</span>
                    </label>
                    <!-- Textarea này sẽ được TinyMCE thay thế -->
                    <textarea id="content"
                              class="form-textarea"
                              placeholder="Write your blog content here..."
                              required></textarea>
                </div>
            </div>

            <!-- ... (Form Actions không đổi) ... -->
            <div class="form-actions">
                <button type="button" class="btn btn-secondary" onclick="window.location.href='/admin/blog'">
                    Cancel
                </button>
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    @if (isEdit)
                    {
                        <text>Update Blog</text>
                    }
                    else
                    {
                        <text>Create Blog</text>
                    }
                </button>
            </div>
        </form>
    </div>
</div>

<!-- ... (Loading Overlay không đổi) ... -->
<div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
</div>

<script>
    const isEditMode = @(isEdit ? "true" : "false");
    const blogId = '@blogId';
    let categories = [];
    // let tinyEditor = null; // Biến để giữ instance của editor

    document.addEventListener('DOMContentLoaded', function () {
        loadDropdownData();

        // === BƯỚC 3: KHỞI TẠO TINYMCE ===
        initTinyMCE();

        setupForm();

        // Bỏ loadBlogData() ở đây, nó sẽ được gọi bởi TinyMCE callback
        // if (isEditMode && blogId) {
        //     loadBlogData(blogId);
        // }
    });

    // === BƯỚC 4: HÀM MỚI ĐỂ KHỞI TẠO TINYMCE ===
    function initTinyMCE() {
        tinymce.init({
            selector: '#content',
            license_key: 'gpl',
            plugins: 'lists link image table code help wordcount',
            toolbar: 'undo redo | blocks | bold italic | alignleft aligncenter alignright | bullist numlist | link image | code | help',
            height: 400,
            setup: (editor) => {
                // Hook này sẽ chạy khi editor *chuẩn bị* khởi tạo
                // editor.on('init', ...) sẽ chạy khi editor *đã sẵn sàng*
                editor.on('init', () => {
                    // Chỉ gọi loadBlogData KHI editor đã sẵn sàng
                    if (isEditMode && blogId) {
                        loadBlogData(blogId);
                    }
                });
            }
        });
    }

    async function loadDropdownData() {
        try {
            const categoriesRes = await fetch('/api/BlogCategories');
            if (categoriesRes.ok) {
                categories = await categoriesRes.json();
                populateCategories();
            } else {
                showError('Failed to load categories');
            }
        } catch (error) {
            console.error('Error loading dropdown data:', error);
            showError('Failed to load form data');
        }
    }

    function populateCategories() {
        const select = document.getElementById('categoryUid');
        select.innerHTML = '<option value="">Select Category</option>' +
            categories.map(cat => `<option value="${cat.uid}">${cat.name}</option>`).join('');
    }

    async function loadBlogData(id) {
        showLoading(true);
        try {
            const response = await fetch(`/admin/blog/api/detail/${id}`);
            if (response.ok) {
                const blog = await response.json();
                fillFormData(blog);
            } else {
                showError('Blog not found');
                setTimeout(() => window.location.href = '/admin/blog', 2000);
            }
        } catch (error) {
            console.error('Error loading blog:', error);
            showError('Failed to load blog data');
        } finally {
            showLoading(false);
        }
    }

    function fillFormData(blog) {
        document.getElementById('title').value = blog.title;
        document.getElementById('categoryUid').value = blog.categoryUid;
        document.getElementById('imageUrl').value = blog.imageUrl || '';
        previewImage();

        // === BƯỚC 5: SỬA HÀM FILL DATA ===
        // Dùng API của TinyMCE để set content
        const editor = tinymce.get('content');
        if (editor) {
            editor.setContent(blog.content || '');
        } else {
            // Fallback nếu editor chưa sẵn sàng (mặc dù setup callback nên xử lý việc này)
            document.getElementById('content').value = blog.content || '';
        }
    }

    function previewImage() {
        const url = document.getElementById('imageUrl').value;
        const preview = document.getElementById('imagePreview');

        if (url) {
            preview.src = url;
            preview.classList.add('show');
        } else {
            preview.classList.remove('show');
        }
    }

    function setupForm() {
        document.getElementById('blogForm').addEventListener('submit', async function (e) {
            e.preventDefault();
            await saveBlog();
        });
        document.getElementById('uploadBtn').addEventListener('click', uploadImage);
    }

    // Hàm uploadImage (không đổi)
    async function uploadImage() {
        const fileInput = document.getElementById('imageFile');
        if (fileInput.files.length === 0) {
            showError('Please select a file to upload first.');
            return;
        }

        const file = fileInput.files[0];
        const formData = new FormData();
        formData.append('file', file);

        showLoading(true);
        const uploadBtn = document.getElementById('uploadBtn');
        uploadBtn.disabled = true;

        try {
            const response = await fetch('/admin/blog/api/upload-image', {
                method: 'POST',
                body: formData
            });

            if (response.ok) {
                const result = await response.json();
                document.getElementById('imageUrl').value = result.imageUrl;
                previewImage();
                showSuccess('Image uploaded successfully!');
                fileInput.value = '';
            } else {
                const error = await response.json();
                showError(error.message || 'Failed to upload image');
            }
        } catch (error) {
            console.error('Error uploading image:', error);
            showError('An error occurred during upload.');
        } finally {
            showLoading(false);
            uploadBtn.disabled = false;
        }
    }


    async function saveBlog() {
        // === BƯỚC 6: SỬA HÀM SAVEBLOG ===

        // Lấy content từ TinyMCE
        const content = tinymce.get('content').getContent();

        const formData = {
            title: document.getElementById('title').value,
            categoryUid: parseInt(document.getElementById('categoryUid').value),
            imageUrl: document.getElementById('imageUrl').value,
            content: content // Gán content đã lấy
        };

        // Validation (cũng kiểm tra biến 'content')
        if (!formData.title || !formData.categoryUid || !content) {
            showError('Please fill in all required fields (Title, Category, Content)');
            return;
        }

        showLoading(true);
        const submitBtn = document.getElementById('submitBtn');
        submitBtn.disabled = true;

        try {
            const url = isEditMode ? `/admin/blog/api/update/${blogId}` : '/admin/blog/api/create';
            const method = isEditMode ? 'PUT' : 'POST';

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });

            if (response.ok) {
                const message = isEditMode ? 'Blog updated successfully!' : 'Blog created successfully!';
                showSuccess(message);

                setTimeout(() => {
                    window.location.href = '/admin/blog';
                }, 1500);
            } else {
                const error = await response.json();
                showError(error.message || 'Failed to save blog');
            }
        } catch (error) {
            console.error('Error:', error);
            showError('An error occurred while saving');
        } finally {
            showLoading(false);
            submitBtn.disabled = false;
        }
    }

    // ... (Các hàm showLoading, showSuccess, showError không đổi) ...
    function showLoading(show) {
        const overlay = document.getElementById('loadingOverlay');
        if (show) {
            overlay.classList.add('show');
        } else {
            overlay.classList.remove('show');
        }
    }
    function showSuccess(message) {
        const alert = document.getElementById('successAlert');
        document.getElementById('successMessage').textContent = message;
        alert.classList.add('show');
        setTimeout(() => alert.classList.remove('show'), 3000);
        document.getElementById('errorAlert').classList.remove('show');
    }
    function showError(message) {
        const alert = document.getElementById('errorAlert');
        document.getElementById('errorMessage').textContent = message;
        alert.classList.add('show');
        setTimeout(() => alert.classList.remove('show'), 5000);
        document.getElementById('successAlert').classList.remove('show');
    }
</script>